---
import Layout from '../Layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import FeaturesGrid from '../components/Features.astro';
import TrustBar from '../components/TrustBar.svelte'; 
import VisualTeardown from '../components/VisualTeardown.svelte';
import ComparisonTable from '../components/ComparisonTable.svelte';
// 1. Import the Final CTA component
import FinalCTA from '../components/FinalCTA.svelte';
import type { HomepageResponse, Section } from '../types/drupal';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8080';

const response = await fetch(`${API_URL}/page?slug=/`);

if (!response.ok) {
  const errorText = await response.text();
  throw new Error(`Backend Error: ${errorText}`);
}

const data: HomepageResponse = await response.json();

// 2. Register the machine names for all 6 components
const COMPONENTS = {
  'paragraph--hero': Hero,
  'paragraph--features_grid': FeaturesGrid,
  'paragraph--trust_bar': TrustBar,
  'paragraph--visual_teardown': VisualTeardown, 
  'paragraph--comparison_table': ComparisonTable,
  'paragraph--cta': FinalCTA,
} as const;

type ComponentKey = keyof typeof COMPONENTS;
---

<Layout title={data.title}>
  {data.sections && data.sections.map((section: Section) => {
    // Handle Interactive Svelte Components (client:load required for inputs/hotspots)
    if (section.type === 'paragraph--visual_teardown') {
      return <VisualTeardown {...(section.content as any)} client:load />;
    }
    
    if (section.type === 'paragraph--trust_bar') {
      return <TrustBar {...(section.content as any)} client:load />;
    }

    // 3. New interactive logic for the CTA (client:load required for the weight input)
    if (section.type === 'paragraph--final_cta') {
      return <FinalCTA {...(section.content as any)} client:load />;
    }

    // Handle Static Components via the Map
    const StaticComponent = COMPONENTS[section.type as ComponentKey];
    return StaticComponent ? <StaticComponent {...(section.content as any)} /> : null;
  })}
</Layout>