---
// src/components/NutritionCalculator.astro
import { ClientRouter } from 'astro:transitions';
---
<head>
  <ClientRouter />
</head>

<nutrition-calculator>
  <div class="calculator-frame">
    <div id="form-view" class="view active">
      <header class="header-lockup">
        <span class="eyebrow">Phase 01: Input</span>
        <h2 class="title">Analyze Your Dog</h2>
      </header>

      <div class="input-stack">
        <div class="field">
          <label for="dogName">Dog's Name</label>
          <input type="text" id="dogName" placeholder="Your Pet's Name" required />
        </div>
        
        <div class="field">
          <label for="weight">Weight (lbs)</label>
          <input type="number" id="weight" placeholder="00" required />
        </div>
        
        <div class="field">
          <label for="activity">Activity Level (1-5)</label>
          <input type="range" id="activity" min="1" max="5" step="1" value="3" />
          <div class="range-labels">
            <span>Couch Potato</span>
            <span>Athlete</span>
          </div>
        </div>
      </div>

      <button id="calc-btn" class="btn-primary-slick">Calculate Instant Plan</button>
    </div>

    <div id="result-view" class="view">
      <div class="prescription-card">
        <header class="prescription-header">
          <span class="eyebrow">Vet-Grade Analysis</span>
          <h2 class="title">Protocol for <span id="res-name"></span></h2>
        </header>

        <div class="metric-grid">
          <div class="metric">
            <span class="label">Daily Target</span>
            <div class="value"><span id="res-cals"></span><small>kcal</small></div>
          </div>
          <div class="metric">
            <span class="label">Daily Portion</span>
            <div class="value"><span id="res-grams"></span><small>g</small></div>
          </div>
        </div>

        <div class="footer-cta">
          <p>Based on ancestral requirements and RER metabolic math calibrated to your dog's specific profile.</p>
          <div class="action-group">
            <a href="/register" id="claim-btn" class="btn-primary-slick">Claim This Meal Plan</a>
            <button type="button" class="btn-reset" onclick="location.reload()">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</nutrition-calculator>

<script>
  class NutritionCalculator extends HTMLElement {
    constructor() {
      super();
      this.btn = this.querySelector('#calc-btn');
      this.btn.addEventListener('click', (e) => {
        e.preventDefault();
        this.runEngine();
      });
    }

    async runEngine() {
      // 1. Show 'Processing' UI
  this.btn.innerHTML = "Analyzing Biology for ...";
  this.btn.disabled = true;

  // 2. Artificial delay to build 'Perceived Value'
  await new Promise(resolve => setTimeout(resolve, 1200));
      const dogName = this.querySelector('#dogName').value;
      const weightLbs = this.querySelector('#weight').value;
      const activity = this.querySelector('#activity').value;

      if (!dogName || !weightLbs) return alert("Missing Info");

      const payload = {
        name: dogName,
        weightKG: parseFloat(weightLbs) / 2.20462,
        activityLevel: parseInt(activity)
      };

      try {
        const response = await fetch('http://localhost:8080/api/calculate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!document.startViewTransition) {
          this.updateUI(data, weightLbs, activity);
          return;
        }

        document.startViewTransition(() => {
          this.updateUI(data, weightLbs, activity);
        });

      } catch (err) {
        console.error("Engine Error:", err);
      }
    }

    updateUI(data, weightLbs, activity) {
      this.querySelector('#form-view').classList.remove('active');
      this.querySelector('#result-view').classList.add('active');

      this.querySelector('#res-name').textContent = data.dogName;
      this.querySelector('#res-cals').textContent = Math.round(data.dailyCalories);
      this.querySelector('#res-grams').textContent = Math.round(data.portionGrams);

      const params = new URLSearchParams({
        dog_name: data.dogName,
        weight: weightLbs,
        calories: Math.round(data.dailyCalories),
        activity: activity
      });
      this.querySelector('#claim-btn').href = `/register?${params.toString()}`;
    }
  }
  customElements.define('nutrition-calculator', NutritionCalculator);
</script>

<style>
  :root {
    --accent: #ff6b6b;
    --brand-dark: #0f172a;
    --studio-white: #ffffff;
    --subtle-gray: #f1f5f9;
    --glass-border: rgba(15, 23, 42, 0.08);
  }

  nutrition-calculator {
    font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
    display: block;
    -webkit-font-smoothing: antialiased;
  }

  .calculator-frame {
    background: var(--studio-white);
    max-width: 850px;
    margin: 4rem auto;
    border-radius: 4px;
    position: relative;
    box-shadow: 
      0 0 0 1px var(--glass-border),
      0 2px 4px rgba(0,0,0,0.02),
      0 30px 60px -12px rgba(15, 23, 42, 0.12); 
    overflow: clip;
    contain: layout;
  }

  .view { padding: 5rem; display: none; min-height: 600px; }
  .view.active { display: block; }

  .header-lockup { margin-bottom: 4rem; }
  .eyebrow { 
    font-family: ui-monospace, monospace;
    font-size: 0.7rem; 
    text-transform: uppercase; 
    letter-spacing: 0.4em; 
    color: var(--accent); 
    font-weight: 800;
  }

  .title {
    font-size: 3.5rem; 
    font-weight: 900;
    letter-spacing: -0.05em;
    margin-top: 1rem;
    text-transform: uppercase;
    color: var(--brand-dark);
    line-height: 0.9;
  }

  /* --- Spacing Fix Applied Here --- */
  .input-stack { 
    display: flex;
    flex-direction: column;
    gap: 2.5rem; /* Consistent vertical rhythm */
    margin-bottom: 4rem;
  }
  
  .field label { 
    display: block; 
    font-weight: 900; 
    text-transform: uppercase; 
    font-size: 0.65rem; 
    margin-bottom: 1.25rem; 
    color: #94a3b8;
    letter-spacing: 0.1em;
  }

  input[type="text"], input[type="number"] {
    width: 100%;
    font-size: 1.5rem;
    font-weight: 600;
    border: 2px solid var(--subtle-gray);
    padding: 1.25rem 1.5rem;
    border-radius: 4px;
    outline: none;
    background: var(--subtle-gray);
    transition: all 0.2s ease;
  }

  input:focus {
    background: white;
    border-color: var(--brand-dark);
    box-shadow: 0 10px 20px -10px rgba(0,0,0,0.1);
  }

  input[type="range"] { width: 100%; accent-color: var(--brand-dark); margin: 1rem 0; }
  .range-labels { display: flex; justify-content: space-between; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #94a3b8; }

  /* --- Result Styling --- */
  .prescription-header { border-bottom: 1px solid #eee; padding-bottom: 2rem; margin-bottom: 3rem; }
  .metric-grid { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 4rem; }
  
  .metric .label { display: block; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; margin-bottom: 0.5rem; }
  .metric .value { font-size: 6rem; font-weight: 900; letter-spacing: -0.06em; line-height: 0.8; color: var(--brand-dark); }
  .metric .value small { font-size: 1.2rem; font-weight: 700; color: #cbd5e1; margin-left: 0.5rem; }

  .footer-cta p { font-size: 1.1rem; color: #64748b; margin-bottom: 3rem; line-height: 1.6; max-width: 500px; }
/* --- Tightened Primary Button --- */
.btn-primary-slick {
    display: inline-block; /* Changed from block to inline-block to prevent full-width growth */
    background: var(--brand-dark);
    color: #fff;
    padding: 1.25rem 2.5rem; /* Reduced padding for a tighter look */
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border: none;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 240px; /* Ensures a consistent, professional base width */
  }

  .btn-primary-slick:hover {
    background: var(--accent);
    /* Reduced scale from 1.02 to 1.01 and Y-translation from -4px to -2px */
    transform: translateY(-2px) scale(1.01); 
    box-shadow: 0 12px 24px -8px rgba(255,107,107,0.3);
  }

  /* --- Ensuring the Action Group doesn't force growth --- */
  .action-group { 
    display: flex; /* Switched from grid to flex for better control */
    align-items: center;
    gap: 1.5rem; 
    margin-top: 3rem; 
  }
  .btn-reset { background: #fff; border: 1px solid var(--glass-border); font-weight: 800; text-transform: uppercase; font-size: 0.7rem; cursor: pointer; color: #94a3b8; }

  /* --- View Transitions --- */
  #form-view, #result-view { view-transition-name: calc-content; }
  ::view-transition-old(calc-content) { animation: 300ms ease both fade-out; }
  ::view-transition-new(calc-content) { animation: 500ms ease both fade-in, 500ms ease both slide-up; }

  @keyframes fade-out { to { opacity: 0; } }
  @keyframes fade-in { from { opacity: 0; } }
  @keyframes slide-up { from { transform: translateY(30px); } }
</style>